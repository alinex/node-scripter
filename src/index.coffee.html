<!DOCTYPE html>
<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-scripter/src/index.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#main-controlling-class">Main controlling class</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#helper">Helper</a>
      </div>

      <div class="heading h1">
        <a href="#add-schema-for-modules-configuration">add schema for module&#39;s configuration</a>
      </div>

      <div class="heading h2">
        <a href="#error-management">Error management</a>
      </div>

      <div class="heading h2">
        <a href="#get-the-job">Get the job</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-scripter" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="main-controlling-class">
  <h1>
    <a href="#main-controlling-class" name="main-controlling-class" class="pilcrow"></a>
Main controlling class
  </h1>
</div>
<p>This is the real main class which can be called using it's API. Other modules
like the cli may be used as bridges to this.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>) <span class="hljs-string">'scripter'</span>
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">Report = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-report'</span>
{string, object} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
Exec = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-exec'</span>
config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
database = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-database'</span>
mail = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-mail'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include classes and helpers</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper">
  <h2>
    <a href="#helper" name="helper" class="pilcrow"></a>
Helper
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.setup = <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
  async.each [Exec, database, mail], <span class="hljs-function"><span class="hljs-params">(mod, cb)</span> -&gt;</span>
    mod.setup cb
  , <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <p>no own schema</p>
<div class="pilwrap" id="add-schema-for-modules-configuration">
  <h1>
    <a href="#add-schema-for-modules-configuration" name="add-schema-for-modules-configuration" class="pilcrow"></a>
add schema for module's configuration
  </h1>
</div>
<pre><code> config.setSchema '/scripter', schema
</code></pre>
<p>set module search path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    config.register <span class="hljs-string">'scripter'</span>, path.dirname __dirname
    cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="error-management">
  <h2>
    <a href="#error-management" name="error-management" class="pilcrow"></a>
Error management
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">exit</span> = <span class="hljs-params">(code = <span class="hljs-number">0</span>, err)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>exit without error</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  process.exit code <span class="hljs-keyword">unless</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>exit with error</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-built_in">console</span>.error chalk.red.bold <span class="hljs-string">"FAILED: <span class="hljs-subst">#{err.message}</span>"</span>
  <span class="hljs-built_in">console</span>.error err.description <span class="hljs-keyword">if</span> err.description
  process.exit code</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-the-job">
  <h2>
    <a href="#get-the-job" name="get-the-job" class="pilcrow"></a>
Get the job
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.job = <span class="hljs-function"><span class="hljs-params">(name, file)</span> -&gt;</span>
  <span class="hljs-keyword">try</span>
    lib = <span class="hljs-built_in">require</span> file
  <span class="hljs-keyword">catch</span> error
    exit <span class="hljs-number">1</span>, error <span class="hljs-keyword">if</span> error</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>setup module</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  lib.name = name
  lib.report = <span class="hljs-keyword">new</span> Report()
  lib.debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>) <span class="hljs-string">"scripter:<span class="hljs-subst">#{name}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>return builder and handler</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">builder</span>: <span class="hljs-function"><span class="hljs-params">(yargs)</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">'BUILDER'</span>
    yargs
    .usage <span class="hljs-string">"\nUsage: $0 <span class="hljs-subst">#{name}</span> [options]"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>add options</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    yargs.option key, def <span class="hljs-keyword">for</span> key, def <span class="hljs-keyword">of</span> lib.options
    yargs.group Object.keys(lib.options), <span class="hljs-string">"<span class="hljs-subst">#{string.ucFirst name}</span> Job Options:"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>help</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    yargs.strict()
    .help <span class="hljs-string">'h'</span>
    .alias <span class="hljs-string">'h'</span>, <span class="hljs-string">'help'</span>
    .epilogue <span class="hljs-string">"For more information, look into the man page."</span>
  <span class="hljs-attribute">handler</span>: <span class="hljs-function"><span class="hljs-params">(args)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>init report</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    lib.start = <span class="hljs-keyword">new</span> Date()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>run job</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    debug <span class="hljs-string">"run <span class="hljs-subst">#{name}</span> handler..."</span>
    <span class="hljs-built_in">console</span>.log()
    <span class="hljs-keyword">try</span>
      lib.handler args, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
        debug <span class="hljs-string">"finished <span class="hljs-subst">#{name}</span> handler"</span>
        <span class="hljs-built_in">console</span>.log()
        lib.end = <span class="hljs-keyword">new</span> Date()
        finish lib, args, err
    <span class="hljs-keyword">catch</span> error
      error.description = error.stack.split(<span class="hljs-regexp">/\n/</span>)[<span class="hljs-number">1.</span>.].join <span class="hljs-string">'\n'</span>
      exit <span class="hljs-number">1</span>, error
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
<span class="hljs-function">
<span class="hljs-title">finish</span> = <span class="hljs-params">(job, args, err)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'Done.'</span>
  <span class="hljs-built_in">console</span>.log()
  <span class="hljs-built_in">console</span>.log job.report.toConsole()
  <span class="hljs-built_in">console</span>.log()
  <span class="hljs-keyword">if</span> args.mail?
    debug <span class="hljs-string">"sending email..."</span>
    email = object.extendArrayReplace {}, {<span class="hljs-attribute">base</span>: <span class="hljs-string">'default'</span>}, job.email
    <span class="hljs-keyword">if</span> ~args.mail.indexOf <span class="hljs-string">'@'</span>
      email.to = args.mail.split <span class="hljs-regexp">/\s*,\s*/</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> args.mail <span class="hljs-keyword">and</span> config.get <span class="hljs-string">"/email/<span class="hljs-subst">#{args.mail}</span>"</span>
      object.extend email, {<span class="hljs-attribute">base</span>: args.mail}
    email = mail.resolve email
    <span class="hljs-keyword">if</span> ~args.mail.indexOf <span class="hljs-string">'@'</span>
      <span class="hljs-keyword">delete</span> email.cc
      <span class="hljs-keyword">delete</span> email.bcc
    mail.send email,
      <span class="hljs-attribute">title</span>: job.title ? string.ucFirst job.name
      <span class="hljs-attribute">description</span>: job.description
      <span class="hljs-attribute">start</span>: job.start
      <span class="hljs-attribute">end</span>: job.end
      <span class="hljs-attribute">report</span>: job.report.toString()
    , <span class="hljs-function"><span class="hljs-params">(merr)</span> -&gt;</span>
      <span class="hljs-built_in">console</span>.log chalk.grey <span class="hljs-string">"Email was send."</span> <span class="hljs-keyword">unless</span> merr
      exit <span class="hljs-number">1</span>, err <span class="hljs-keyword">if</span> err
      exit <span class="hljs-number">128</span>, merr <span class="hljs-keyword">if</span> merr
      exit <span class="hljs-number">0</span>
  <span class="hljs-keyword">else</span>
    exit <span class="hljs-number">1</span>, err <span class="hljs-keyword">if</span> err
    exit <span class="hljs-number">0</span></pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
